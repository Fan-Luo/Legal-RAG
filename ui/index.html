<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Legal-RAG</title>
    <style>
      .muted{ color: var(--muted); font-size: 13px; }
      .row{ display:flex; }

      :root{
        --bg: #f6f7fb;
        --surface: #ffffff;
        --text: #0f172a;
        --muted: #64748b;
        --border: #e5e7eb;
        --shadow: 0 8px 30px rgba(15, 23, 42, 0.08);
        --accent: #2563eb;
        --accent-weak: rgba(37,99,235,.12);
        --radius: 16px;
        --radius-sm: 12px;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      }

      *{ box-sizing: border-box; }
      html, body { height: 100%; }
      body{
        margin: 0;
        font-family: var(--sans);
        color: var(--text);
        background: radial-gradient(1200px 800px at 10% 10%, #eef2ff 0%, rgba(238,242,255,0) 55%),
                    radial-gradient(900px 700px at 90% 0%, #ecfeff 0%, rgba(236,254,255,0) 45%),
                    var(--bg);
      }

      .app{
        height: 100%;
        display: grid;
        grid-template-columns: minmax(520px, 1fr) 420px;
        gap: 16px;
        padding: 16px;
      }

      @media (max-width: 980px){
        .app{ grid-template-columns: 1fr; }
        .side{ order: 2; }
        .chat{ order: 1; }
      }

      /* ---------- Cards ---------- */
      .card{
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .card-header{
        padding: 18px 18px 12px 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .card-title{
        font-size: 16px;
        font-weight: 750;
        letter-spacing: -0.02em;
      }

      .card-subtitle{
        padding: 0 18px 12px 18px;
        color: var(--muted);
        font-size: 14px;
      }

      .card-body{
        padding: 16px 18px 18px 18px;
      }

      .card-summary{
        list-style: none;
        cursor: pointer;
        padding: 18px;
        font-size: 16px;
        font-weight: 750;
        border-bottom: 1px solid var(--border);
      }
      details.card > summary::-webkit-details-marker{ display: none; }

      /* ---------- Chat ---------- */
      .chat{
        display: flex;
        flex-direction: column;
        min-height: 0;
        gap: 12px;
      }

      .topbar{
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 12px 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .brand{
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo{
        width: 38px;
        height: 38px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--accent), #7c3aed);
        color: #fff;
        display: grid;
        place-items: center;
        font-weight: 900;
      }

      .brand-text .title{
        font-size: 18px;
        font-weight: 800;
        line-height: 1.1;
      }
      .brand-text .subtitle{
        font-size: 12px;
        color: var(--muted);
        margin-top: 2px;
      }

      .topbar-actions{
        display: flex;
        gap: 10px;
      }

      .chat-list{
        flex: 1;
        min-height: 0;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 16px;
        overflow: auto;
      }

      .msg{
        display: flex;
        margin: 10px 0;
      }
      .msg.user{ justify-content: flex-end; }
      .msg.assistant{ justify-content: flex-start; }

      .bubble{
        max-width: 78%;
        border-radius: 18px;
        padding: 12px 14px;
        border: 1px solid var(--border);
        background: #fff;
      }
      .msg.user .bubble{
        background: #f1f5ff;
        border-color: rgba(37,99,235,.25);
      }
      .role{
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 6px;
      }
      .content{
        font-size: 14.5px;
        line-height: 1.55;
        white-space: normal;
      }

      /* ---------- Composer ---------- */
      .composer{
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 12px;
      }

      .composer-inner{
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: end;
      }

      .composer-input{
        width: 100%;
        resize: none;
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px 12px;
        font-size: 14.5px;
        line-height: 1.45;
        outline: none;
      }
      .composer-input:focus{
        border-color: rgba(37,99,235,.55);
        box-shadow: 0 0 0 4px var(--accent-weak);
      }

      .composer-actions{
        display: flex;
        gap: 10px;
      }

      .composer-hint{
        margin-top: 10px;
        color: var(--muted);
        font-size: 12px;
      }

      /* ---------- Buttons ---------- */
      .btn{
        height: 40px;
        padding: 0 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #fff;
        cursor: pointer;
        font-weight: 700;
      }
      .btn:disabled{
        opacity: .6;
        cursor: not-allowed;
      }
      .btn-primary{
        background: var(--accent);
        border-color: rgba(37,99,235,.85);
        color: #fff;
      }
      .btn-primary:hover{ filter: brightness(.98); }
      .btn-ghost{
        background: #fff;
      }
      .btn-ghost:hover{
        background: #f8fafc;
      }

      /* ---------- Sidebar ---------- */
      .side{
        display: flex;
        flex-direction: column;
        min-height: 0;
        gap: 16px;
      }

      /* Toggle */
      .toggle{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:6px 10px;
        border:1px solid rgba(15,23,42,.08);
        background: rgba(15,23,42,.03);
        color: inherit;
        border-radius: 999px;
        cursor:pointer;
        user-select:none;
      }
      .toggle:hover{ background: rgba(15,23,42,.06); }

      .toggle .chev{
        display:inline-block;
        transform: rotate(-90deg); /* collapsed */
        transition: transform .15s ease;
        font-weight: 700;
        line-height: 1;
      }
      .toggle[aria-expanded="true"] .chev{
        transform: rotate(0deg); /* expanded -> v */
      }

      /* Evidence list */
      .evidence-wrap{
        padding: 0 18px 18px 18px;
        min-height: 180px;
      }

      .evidence-wrap.show{ display:block; }
      .evidence-wrap:not(.show){ display:none; }

      .evidence-list{
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 10px;
        max-height: 52vh;
        overflow: auto;
        background: #fff;
      }

      .evi{
        border: 1px solid var(--border);
        border-radius: 14px;
        background: #fff;
        overflow: hidden;
        margin: 10px 0;
      }

      .evi-sum{
        cursor: pointer;
        list-style: none;
        padding: 14px 14px;
        display: flex;
        align-items: center;
        width: 100%;
        gap: 10px;
        font-weight: 800;
        border-radius: 14px;
      }
      .evi-sum::-webkit-details-marker{ display: none; }

      .evi-sum::before{
        content: "▸";
        margin-right: 5px;
        color: var(--accent);
        font-weight: 900;
      }
      .evi[open] .evi-sum::before{ content: "▾"; }

      .evi-left{
        display: flex;
        align-items: center;
        gap: 3px;
        font-size: 16px;
        width: 100%;
      }

      .evi-right{
        color: var(--muted);
        align-items: center;
        font-weight: 750;
        font-size: 15px;
        white-space: nowrap;
      }

      .evi-body{
        padding: 12px 14px 14px 14px;
        border-top: 1px solid var(--border);
        max-height: 220px;
        overflow: auto;
      }

      .evi-text{
        font-size: 14.5px;
        line-height: 1.65;
        color: var(--text);
      }

      .pill{
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        color: var(--muted);
        font-weight: 800;
        font-size: 12px;
        background: #fff;
        font-family: var(--mono);
      }

      /* Input (key) */
      .key-input{
        height: 40px;
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 0 12px;
        outline: none;
        font-size: 13px;
      }
      .key-input:focus{
        border-color: rgba(37,99,235,.55);
        box-shadow: 0 0 0 4px var(--accent-weak);
      }
    </style>
  </head>

  <body>
    <div class="app">
      <!-- Left: Chat -->
      <section class="chat">
        <header class="topbar">
          <div class="brand">
            <div class="logo">L</div>
            <div class="brand-text">
              <div class="title">Legal-RAG</div>
              <div class="subtitle">Contract Law · RAG</div>
            </div>
          </div>

          <div class="topbar-actions">
            <button id="newChatBtn" class="btn btn-ghost" type="button">New chat</button>
          </div>
        </header>

        <div id="chatList" class="chat-list" aria-live="polite"></div>

        <form id="chatForm" class="composer" autocomplete="off">
          <div class="composer-inner">
            <textarea
              id="question"
              class="composer-input"
              placeholder="输入你的法律问题…（Enter 发送，Shift+Enter 换行）"
              rows="2"
            ></textarea>
            <div class="composer-actions">
              <button id="sendBtn" class="btn btn-primary" type="submit">Send</button>
              <button id="clearBtn" class="btn btn-ghost" type="button">Clear</button>
            </div>
          </div>
          <div class="composer-hint">
            免责声明：仅供参考，不构成法律意见。请结合具体事实与完整条文判断。 <br />
            Disclaimer: Provided for informational purposes only; not a substitute for professional legal counsel.
          </div>
        </form>
      </section>

      <!-- Right: Sidebar -->
      <aside class="side">
        <!-- Evidence -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Evidences / 法律依据</div>
            <button
              id="evidenceToggle"
              class="toggle"
              type="button"
              aria-expanded="false"
              aria-controls="evidenceWrap"
            >
              <span class="chev" aria-hidden="true">v</span>
              <span class="toggleText" id="evidenceToggleText">Expand / 展开</span>
            </button>
          </div>

          <div id="evidenceHint" class="card-subtitle">Ask a question to see citations.</div>

          <div id="evidenceWrap" class="evidence-wrap">
            <div id="evidenceList" class="evidence-list"></div>
          </div>
        </div>

        <!-- Upload -->
        <details class="card" open>
          <summary class="card-summary">Upload PDF  / 上传文件</summary>
          <div class="card-body">
            <div style="display:grid; gap:10px;">
              <div class="card-subtitle" style="margin: 0; padding: 0;">
                上传 PDF 扩展语料 / Upload a PDF to extend corpus
              </div>
              <input id="pdfFile" type="file" accept="application/pdf" />
              <div>
                <span id="pdfHint" style="display:none; color:red; font-size:12pt; padding-bottom: 2px;">Max 10MB</span>
              </div>
            </div>

            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
              <button id="uploadBtn" class="btn" type="button">Upload</button>
              <button id="clearUploadBtn" class="btn btn-ghost" type="button">Clear</button>
            </div>

            <div style="margin-top:12px;">
              <div id="uploadStatus" class="muted" style="white-space:pre-wrap;"></div>
            </div>
          </div>
        </details>

        <!-- OpenAI API Key -->
        <div class="card">
          <div class="card-body">
            <div class="row" style="gap:5px; align-items:center;">
            <label style="min-width:130px; font-weight:700">OpenAI API Key</label>
            <input id="openaiKey" type="password" placeholder="sk-..." style="flex:1;" />
            <button id="saveKeyBtn" type="button">Save</button>
            <button id="clearKeyBtn" type="button">Clear</button>
          </div>
            </div>
            <div class="muted" style="margin:8px; line-height:1.4;">
              <div><small>This Space has no GPU. Provide your own OpenAI key to enable answers.</small></div>
              <div>
                <small>Get a key from <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener noreferrer"><span style="font-family:monospace;">platform.openai.com/api-keys</span></a>.
                </small>
              </div>
              <div><small>The key is stored only in your browser session.</small></div>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <script>
      const $ = (sel) => document.querySelector(sel);

      const chatList = $("#chatList");
      const chatForm = $("#chatForm");
      const questionInput = $("#question");
      const sendBtn = $("#sendBtn");
      const clearBtn = $("#clearBtn");
      const newChatBtn = $("#newChatBtn");

      const evidenceToggle = $("#evidenceToggle");
      const evidenceToggleText = $("#evidenceToggleText");
      const evidenceHint = $("#evidenceHint");
      const evidenceWrap = $("#evidenceWrap");
      const evidenceList = $("#evidenceList");

      const uploadBtn = $("#uploadBtn");
      const clearUploadBtn = $("#clearUploadBtn");
      const uploadStatus = $("#uploadStatus");
      const pdfHint = $("#pdfHint");
      const pdfFile = $("#pdfFile");

      const openaiKeyInput = $("#openaiKey");
      const saveKeyBtn = $("#saveKeyBtn");
      const clearKeyBtn = $("#clearKeyBtn");

      const KEY_STORAGE = "legalrag_openai_api_key";

      const state = {
        busy: false,
      };

      const MAX_MB = 10;
      const MAX_BYTES = MAX_MB * 1024 * 1024;

      // Restore key from session
      try {
        const saved = sessionStorage.getItem(KEY_STORAGE);
        if (saved && openaiKeyInput) openaiKeyInput.value = saved;
      } catch (e) {}

      // ---------- Helpers ----------
      function escapeHtml(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
<<<<<<< Updated upstream
      async function uploadPdfFile(file) {
        const fd = new FormData();
        fd.append("file", file, file.name);

        const res = await fetch("/ingest/pdf", { method: "POST", body: fd });
        if (!res.ok) {
          const msg = await res.text().catch(() => "");
          throw new Error(`HTTP ${res.status}: ${msg || res.statusText}`);
        }
        return res.json();
      }

      async function pollIngestStatus(docId, { intervalMs = 1500, maxTries = 120 } = {}) {
        for (let i = 0; i < maxTries; i++) {
          const res = await fetch(`/ingest/status/${encodeURIComponent(docId)}`, { method: "GET" });
          if (res.ok) {
            const st = await res.json();
            if (st?.error && st.error !== null && st.error !== "not_found") return st;

            const faissDone = st?.faiss === "done";
            const bm25Done = st?.bm25 === "done";
            if (faissDone && bm25Done) return st;

            uploadStatus.textContent = `Indexing...\n`;
          }
          await new Promise((r) => setTimeout(r, intervalMs));
        }
        return { error: "timeout" };
      }

      function scrollChatToBottom() {
        chatList.scrollTop = chatList.scrollHeight;
      }
=======
>>>>>>> Stashed changes

      function addMessage(role, text) {
        const el = document.createElement("div");
        el.className = `msg ${role}`;
        el.innerHTML = `
          <div class="bubble">
            <div class="role">${role === "user" ? "You" : "Assistant"}</div>
            <div class="content">${escapeHtml(text).replaceAll("\n", "<br/>")}</div>
          </div>
        `;
        chatList.appendChild(el);
        chatList.scrollTop = chatList.scrollHeight;
      }

      function setBusy(on) {
        state.busy = on;
        sendBtn.disabled = on;
        questionInput.disabled = on;
        sendBtn.textContent = on ? "Thinking…" : "Send";
      }

      function getOpenAIKey() {
        return String(openaiKeyInput?.value || "").trim();
      }

      function readSavedKey() {
        try { return String(sessionStorage.getItem(KEY_STORAGE) || "").trim(); } catch (e) {}
        return "";
      }

      function setSavedKey(k) {
        try { sessionStorage.setItem(KEY_STORAGE, k); } catch (e) {}
      }

      function clearSavedKey() {
        try { sessionStorage.removeItem(KEY_STORAGE); } catch (e) {}
      }

      function isEvidenceOpen(){
        return evidenceWrap.classList.contains("show");
      }

      function setEvidenceOpen(open){
        evidenceWrap.classList.toggle("show", open);
        evidenceToggle.setAttribute("aria-expanded", open ? "true" : "false");
        evidenceToggleText.textContent = open ? "Collapse / 收起" : "Expand / 展开";
      }

      function normalizeHits(hits) {
        if (!Array.isArray(hits)) return [];
        return hits.map((h, i) => ({
          rank: Number(h.rank ?? i + 1),
          score: Number(h.score ?? 0),
          article: h.article_no ?? h.article ?? h.articleNo ?? "",
          text: h.text ?? "",
          law_name: h.law_name ?? "",
        }));
      }

      function renderEvidence(hits) {
        const rows = normalizeHits(hits);

        if (!rows.length) {
          evidenceHint.style.display = "block";
          evidenceHint.textContent = "No citations returned.";
          evidenceList.innerHTML = "";
          return;
        }

        evidenceHint.style.display = "none";
        evidenceList.innerHTML = "";

        rows.forEach((h) => {
          const det = document.createElement("details");
          det.className = "evi";
          det.open = false;

          det.addEventListener("toggle", () => {
            if (!det.open) return;
            evidenceList.querySelectorAll("details.evi[open]").forEach((d) => {
              if (d !== det) d.open = false;
            });
          });

          const sum = document.createElement("summary");
          sum.className = "evi-sum";
          sum.innerHTML = `
            <span class="evi-left">[${escapeHtml(h.rank)}] ${escapeHtml(h.article || "条文")}</span>
            <span class="evi-right">score&nbsp;${escapeHtml(h.score.toFixed(2))}</span>
          `;

          const body = document.createElement("div");
          body.className = "evi-body";
          body.innerHTML = `<div class="evi-text">${escapeHtml(h.text).replaceAll("\n", "<br/>")}</div>`;

          det.appendChild(sum);
          det.appendChild(body);
          evidenceList.appendChild(det);
        });
      }

      function updatePdfHintVisibility() {
        const f = pdfFile?.files?.[0];
        if (!f) {
          pdfHint.style.display = "none";
          return;
        }
        pdfHint.style.display = (f.size > MAX_BYTES) ? "inline-flex" : "none";
      }

      async function uploadPdfFile(file) {
        const fd = new FormData();
        fd.append("file", file, file.name);

        const res = await fetch("/ingest/pdf", { method: "POST", body: fd });
        if (!res.ok) {
          const raw = await res.text().catch(() => "");
          throw new Error(await friendlyErrorFromResponse(res.status, raw));
        }
        return res.json();
      }

      async function pollIngestStatus(docId, { intervalMs = 1500, maxTries = 120 } = {}) {
        for (let i = 0; i < maxTries; i++) {
          const res = await fetch(`/ingest/status/${encodeURIComponent(docId)}`, { method: "GET" });
          if (res.ok) {
            const st = await res.json();
            if (st?.error && st.error !== null && st.error !== "not_found") return st;

            const faissDone = st?.faiss === "done";
            const bm25Done = st?.bm25 === "done";
            if (faissDone && bm25Done) return st;

            uploadStatus.textContent = `Indexing...\n`;
          }
          await new Promise((r) => setTimeout(r, intervalMs));
        }
        return { error: "timeout" };
      }

      function trimToConclusion(answer) {
        const s = String(answer ?? "").trim();
        if (!s) return "";
        if (/^结论\s*[:：]/.test(s)) return s;

        const m = s.match(/(?:^|\n)\s*结论\s*[:：]/);
        if (m && typeof m.index === "number") {
          const out = s.slice(m.index).trim();
          const afterColon = out.replace(/^结论\s*[:：]\s*/, "").trim();
          if (afterColon.length >= 2) return out;
          return s;
        }
        return s;
      }

      // ---------- Friendly error handling ----------
      function friendlyErrorMessage(raw) {
        const s = String(raw || "");

        // 1) OpenAI quota
        if (
          /insufficient_quota/i.test(s) ||
          /You exceeded your current quota/i.test(s) ||
          /\bHTTP\s*429\b/i.test(s) ||
          /status[_\s-]*code["']?\s*:\s*429/i.test(s)
        ) {
          return [
            "OpenAI quota/billing issue (insufficient_quota).",
            "Please check your OpenAI plan and billing, or use another API key.",
            "If you just created the key, ensure the account has an active billing method and available quota."
          ].join("\n");
        }

        // 2) Missing key
        if (/OpenAI API Key required/i.test(s) || /\b401\b/.test(s) && /OpenAI/i.test(s)) {
          return "OpenAI API key is required on this Space (no GPU). Please paste your key in the right panel and click Save.";
        }

        // 3) Missing model
        if (/provide a model parameter/i.test(s)) {
          return "OpenAI model is not configured. Please set OPENAI_MODEL on the server (or ensure the backend picks a default like gpt-4o-mini).";
        }

        // 4) Generic server error
        if (/\bHTTP\s*500\b/.test(s) || /Internal Server Error/i.test(s) || /RAG query failed/i.test(s)) {
          return "Server error occurred while processing the request. Please retry. If it persists, check that the index exists and the backend logs for the root cause.";
        }

        // 5) Fallback: show brief
        return s.length > 800 ? (s.slice(0, 800) + " …") : s;
      }

      async function parseErrorPayload(rawText) {
        const t = String(rawText || "").trim();
        if (!t) return "";

        // If looks like HTML (HF 404 page etc), keep only first line
        if (t.startsWith("<!DOCTYPE") || t.startsWith("<html")) return "Unexpected HTML response from server (可能是路由/反代问题)。";

        // Try JSON
        try {
          const j = JSON.parse(t);

          // common shapes:
          //  - {detail: "..."} or {detail: {...}}
          //  - {error: {message, code, type}}
          if (j && typeof j === "object") {
            if (typeof j.detail === "string") return j.detail;
            if (j.detail && typeof j.detail === "object") {
              const d = j.detail;
              return d.message || d.msg || JSON.stringify(d);
            }
            if (j.error && typeof j.error === "object") {
              const e = j.error;
              return e.message || e.msg || JSON.stringify(e);
            }
          }
          return t;
        } catch (_) {
          return t;
        }
      }

      async function friendlyErrorFromResponse(status, rawText) {
        const payload = await parseErrorPayload(rawText);
        const combined = `HTTP ${status}: ${payload || ""}`.trim();
        return friendlyErrorMessage(combined);
      }

      function maybeWarnOnFallback(answerText) {
        const s = String(answerText || "");
        if (!s) return null;

        if (/【降级模式】/i.test(s) || /disabled 模型不可用/i.test(s)) {
          return [
            "LLM is currently unavailable and the system is showing retrieval-only output.",
            "Please ensure your OpenAI key is valid and has quota.",
          ].join("\n");
        }
        if (/insufficient_quota/i.test(s) || /exceeded your current quota/i.test(s)) {
          return friendlyErrorMessage(s);
        }
        return null;
      }

      async function callRag(question) {
        const payload = { question, top_k: 10, answer_style: "专业" };

        const headers = { "Content-Type": "application/json" };
        const k = readSavedKey() || getOpenAIKey();
        if (k) headers["X-OpenAI-Api-Key"] = k;

        const res = await fetch("/rag/query", {
          method: "POST",
          headers,
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const raw = await res.text().catch(() => "");
          const friendly = await friendlyErrorFromResponse(res.status, raw);
          throw new Error(friendly);
        }

        return res.json();
      }

      // ---------- Events ----------
      saveKeyBtn?.addEventListener("click", () => {
        const k = getOpenAIKey();
        if (!k) return alert("Please paste your OpenAI API key first.");
        setSavedKey(k);
        alert("Saved for this browser session.");
      });

      clearKeyBtn?.addEventListener("click", () => {
        if (openaiKeyInput) openaiKeyInput.value = "";
        clearSavedKey();
        alert("Cleared.");
      });

      uploadBtn?.addEventListener("click", async () => {
        const file = pdfFile?.files?.[0];
        if (!file) {
          uploadStatus.textContent = "请选择一个 PDF 文件 / Please choose a PDF file.";
          return;
        }
        if (!/\.pdf$/i.test(file.name)) {
          uploadStatus.textContent = "仅支持 PDF 文件 / PDF only.";
          return;
        }

        uploadBtn.disabled = true;
        clearUploadBtn.disabled = true;
        uploadStatus.textContent = `Uploading: ${file.name} ...`;

        try {
          const data = await uploadPdfFile(file);
          uploadStatus.textContent =
            `Uploaded: ${data.filename}\n` +
            `doc_id: ${data.doc_id}\n` +
            `chunks: ${data.num_chunks}\n\n` +
            `Preview:\n${data.text_preview || ""}\n\n` +
            `Indexing scheduled.`;

          const st = await pollIngestStatus(data.doc_id);
          if (st?.error && st.error !== null && st.error !== "not_found") {
            uploadStatus.textContent += `\n\nIndex error: ${st.error}`;
          } else if (st?.faiss === "done" || st?.bm25 === "done") {
            uploadStatus.textContent =
              `Index ready.\n` +
              `doc_id: ${data.doc_id}\n` +
              `faiss: ${st?.faiss || "unknown"} (added: ${st?.added ?? 0})\n` +
              `bm25: ${st?.bm25 || "unknown"}\n`;
          } else if (st?.error === "timeout") {
            uploadStatus.textContent += `\n\nIndexing is in process. You can continue chatting; it will become available once finished.`;
          }
        } catch (err) {
          uploadStatus.textContent = `Upload failed: ${err?.message || String(err)}`;
        } finally {
          uploadBtn.disabled = false;
          clearUploadBtn.disabled = false;
          if (pdfFile) pdfFile.value = "";
          pdfHint.style.display = "none";
        }
      });

      clearUploadBtn?.addEventListener("click", () => {
        if (pdfFile) pdfFile.value = "";
        uploadStatus.textContent = "";
        pdfHint.style.display = "none";
      });

      evidenceToggle?.addEventListener("click", () => {
        setEvidenceOpen(!isEvidenceOpen());
      });

      pdfFile?.addEventListener("change", updatePdfHintVisibility);

      questionInput?.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          chatForm.requestSubmit();
        }
      });

      clearBtn?.addEventListener("click", () => {
        questionInput.value = "";
        questionInput.focus();
      });

      newChatBtn?.addEventListener("click", () => {
        chatList.innerHTML = "";
        evidenceHint.style.display = "block";
        evidenceHint.textContent = "Ask a question to see citations.";
        evidenceList.innerHTML = "";
        setEvidenceOpen(false);
      });

      chatForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (state.busy) return;

        const q = String(questionInput.value || "").trim();
        if (!q) return;

        addMessage("user", q);
        questionInput.value = "";

        setBusy(true);
        try {
          const data = await callRag(q);

          const answerRaw = String(data.answer ?? "");
          const answer = trimToConclusion(answerRaw) || "（未返回答案）";
          addMessage("assistant", answer);

          // If backend returned fallback text but 200 OK, still provide a friendly hint
          const hint = maybeWarnOnFallback(answerRaw);
          if (hint) addMessage("assistant", hint);

          renderEvidence(data.hits ?? []);
        } catch (err) {
          addMessage("assistant", `请求失败：${err?.message || String(err)}`);
        } finally {
          setBusy(false);
          questionInput.focus();
        }
      });

      // ---------- Init ----------
      // default collapsed
      setEvidenceOpen(false);
      evidenceHint.style.display = "block";
      evidenceHint.textContent = "Ask a question to see citations.";
      evidenceList.innerHTML = "";
    </script>
  </body>
</html>
